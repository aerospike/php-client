on:
  push:

jobs:
  build-php-client:
    runs-on: ubuntu-24.04
    steps:
    # TODO: run EE server from shared repo, not the Python client repo
    - uses: actions/checkout@v4
      with:
        repository: aerospike/aerospike-client-python
        ref: 6db93eb752ee4158b33130de3d42586f14fe41b9
        path: aerospike-client-python
        sparse-checkout: |
          .github
    - name: run-ee-server code relies on relative paths. We cannot call using ./aerospike-client-python/.github/...
      run: mv aerospike-client-python/.github .
    - uses: .github/actions/run-ee-server
    - name: Checkout PHP client repo
      uses: actions/checkout@v4
      with:
        path: main
    - name: Get list of all packages
      run: sudo apt update
    - name: Install prerequisites
    # Rust is already installed, as well as rustup
    # But it doesn't work when we run `make sudo` later on, so we have to reinstall
    # with apt
      run: |
        sudo apt -y install \
          php-dev \
          phpunit \
          build-essential \
          protobuf-compiler \
          rustup
    - name: Download and install latest Rust
      run: sudo rustup default stable
    - name: Install prerequisites using go
      run: |
        go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
        go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
        go get google.golang.org/grpc
      working-directory: aerospike-connection-manager
      shell: sudo bash -e {0}
    - name: Build and run ACM
      run: |
        export PATH="$PATH:$(go env GOPATH)/bin"
        make daemonize
      shell: sudo bash -e {0}
      working-directory: aerospike-connection-manager
    - run: sudo systemctl status aerospike-connection-manager
    - name: Build and install PHP client, then run tests
      run: sudo make test
