on:
  push:

jobs:
  build-macos:
    runs-on: macos-14
    steps:
      - name: Install dependencies
        run: |
          brew install \
            phpunit \
            go \
            protobuf \
            php@8.4
      - uses: actions/checkout@v4
      - name: Build PHP client
        run: make
        env:
          # By default the compiler tries to build for macos 11.0
          MACOSX_DEPLOYMENT_TARGET: 14.7
          # Linker will report errors about some symbols not existing
          # But some symbols are dynamically loaded by PHP
          # https://davidcole1340.github.io/ext-php-rs/getting-started/hello_world.html#cargoconfigtoml
          RUSTFLAGS: "-C link-arg=-Wl,-undefined,dynamic_lookup"
      - name: Install dependencies for ACM
        run: |
          go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
          go get -u google.golang.org/grpc
        working-directory: aerospike-connection-manager
      - run: |
          export PATH="$PATH:$(go env GOPATH)/bin"
          make build
        working-directory: aerospike-connection-manager

  build-linux:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4
    - name: Run EE server with security enabled
      run: docker run -d --mount type=bind,src=$(pwd)/configs,dst=/opt/aerospike/etc -p 3000:3000 --name aerospike aerospike/aerospike-server-enterprise asd --config-file /opt/aerospike/etc/aerospike.conf
      working-directory: .github/workflows
    - name: Wait for server to start
      run: sleep 3
    - run: docker logs aerospike
    - name: Add superuser for testing
      run: docker exec aerospike asadm --user admin --password admin --enable -e "manage acl create user superuser password superuser roles read-write-udf sys-admin user-admin data-admin"
    - name: Get list of all packages
      run: sudo apt update
    - name: Install prerequisites
    # Rust is already installed, as well as rustup
    # But it doesn't work when we run `make sudo` later on, so we have to reinstall
    # with apt
      run: |
        sudo apt -y install \
          php-dev \
          phpunit \
          build-essential \
          protobuf-compiler \
          rustup
    - name: Download and install latest Rust
      run: sudo rustup default stable
    - name: Install prerequisites using go
      run: |
        go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
        go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
        go get google.golang.org/grpc
      working-directory: aerospike-connection-manager
      shell: sudo bash -e {0}
    - name: Build and run ACM
      run: |
        export PATH="$PATH:$(go env GOPATH)/bin"
        make daemonize
      shell: sudo bash -e {0}
      working-directory: aerospike-connection-manager
    - run: sudo systemctl status aerospike-connection-manager
    - name: Build and install PHP client, then run tests
      run: sudo make test
