on:
  push:

jobs:
  build-php-client:
      runs-on: ubuntu-24.04
      steps:
      - name: Get list of all packages
        run: sudo apt update
      - name: Install prerequisites
        run: |
          sudo apt -y install \
            php-dev \
            phpunit \
            build-essential \
            protoc
      - name: Install prerequisites using go
        run: |
          go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
          go get google.golang.org/grpc
      - name: Fix symlinkage of protobuf
        run: |
          which protoc-gen-go
          if [[ $? != 0 ]] ; then
            printf "protobufs not symlinked. Symlinking protobufs...\n"
            ln -s /root/go/bin/protoc-gen-go /usr/bin/
            ln -s /root/go/bin/protoc-gen-go-grpc /usr/bin/
            wait
          else
            printf "protobuf was already installed!\n"
          fi

      - uses: actions/checkout@v4
      - name: Build and install PHP client
        run: make
      - name: Build and run ACM
        run: make
        working-directory: aerospike-connection-manager
